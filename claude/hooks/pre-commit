#!/bin/bash
#
# Pre-commit hook: Block private/work-specific content from public dotfiles repo
#
# Reads blocked patterns from .guardrails file (one pattern per line).
# If .guardrails is missing, warns and exits successfully (non-blocking).
#
# See .guardrails.sample for format and examples.
#
# Installation:
#   cp claude/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

RED='\033[0;31m'
YELLOW='\033[0;33m'
RESET='\033[0m'

REPO_ROOT="$(git rev-parse --show-toplevel)"
GUARDRAILS_FILE="${REPO_ROOT}/.guardrails"
GUARDRAILS_SAMPLE="${REPO_ROOT}/.guardrails.sample"

# Check if .guardrails exists
if [ ! -f "$GUARDRAILS_FILE" ]; then
  echo -e "${YELLOW}WARNING: No .guardrails file found.${RESET}"
  echo "  Create one with blocked patterns (one per line)."
  if [ -f "$GUARDRAILS_SAMPLE" ]; then
    echo "  Quick start: cp .guardrails.sample .guardrails"
  fi
  echo "  Skipping content check."
  exit 0
fi

# Build pattern from .guardrails file (skip comments and blank lines)
BLOCKED_PATTERNS=$(grep -v '^\s*#' "$GUARDRAILS_FILE" | grep -v '^\s*$' | paste -sd '|' -)

if [ -z "$BLOCKED_PATTERNS" ]; then
  exit 0
fi

# Only check staged files (not the whole repo)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|sh|json|yaml|yml|toml|txt)$' || true)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

VIOLATIONS=""
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    matches=$(grep -inE "$BLOCKED_PATTERNS" "$file" 2>/dev/null || true)
    if [ -n "$matches" ]; then
      VIOLATIONS="$VIOLATIONS\n  $file:\n$(echo "$matches" | sed 's/^/    /')\n"
    fi
  fi
done

if [ -n "$VIOLATIONS" ]; then
  echo -e "${RED}BLOCKED: Private content detected in staged files.${RESET}"
  echo -e "${RED}This is a public repository â€” patterns from .guardrails matched.${RESET}"
  echo ""
  echo -e "Violations:$VIOLATIONS"
  echo "Options:"
  echo "  1. Replace with generic placeholders (MyApp, my_app_dev, etc.)"
  echo "  2. Move the file to a private location (not tracked by dotfiles)"
  echo "  3. Override with: git commit --no-verify (use with caution)"
  exit 1
fi

exit 0
